<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Life Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Babel for JSX support -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body {
        background-color: #0f172a; /* slate-900 fallback */
        color: #f1f5f9; /* slate-100 */
        -webkit-font-smoothing: antialiased;
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      }
      /* Hide scrollbar for clean mobile look */
      ::-webkit-scrollbar {
        width: 0px;
        background: transparent;
      }
      .animate-fade-in {
        animation: fadeIn 0.5s ease-out;
      }
      .animate-fade-in-up {
        animation: fadeInUp 0.5s ease-out;
      }
      .animate-slide-in-right {
        animation: slideInRight 0.3s ease-out;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes slideInRight {
        from { opacity: 0; transform: translateX(100%); }
        to { opacity: 1; transform: translateX(0); }
      }
      /* Date picker custom styles */
      input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(1);
        cursor: pointer;
      }
    </style>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.3.1",
        "react/": "https://esm.sh/react@18.3.1/",
        "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <!-- Changed type to text/babel and added data-type="module" -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Calendar, Target, Settings, LayoutDashboard, 
            Plus, Minus, Trophy, CalendarRange, 
            TrendingUp, Zap, CheckCircle2, 
            Trash2, LogOut, PlusCircle, Check, Lock, ShieldAlert,
            Lightbulb, ArrowLeft, CheckSquare, CalendarDays, Rocket
        } from 'lucide-react';
        
        import { initializeApp } from "firebase/app";
        import { 
            getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged 
        } from "firebase/auth";
        import { 
            getFirestore, collection, query, where, addDoc, deleteDoc, doc, updateDoc, increment, onSnapshot 
        } from "firebase/firestore";

        // --- SECURITY CONFIGURATION ---
        const ALLOWED_EMAIL = ""; 

        // --- CONSTANTS ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCFQQHx_XumqSgEWfZQav8Wpx0UxMmFj6s",
            authDomain: "life-tracker-1d35b.firebaseapp.com",
            projectId: "life-tracker-1d35b",
            storageBucket: "life-tracker-1d35b.firebasestorage.app",
            messagingSenderId: "571383830152",
            appId: "1:571383830152:web:3c752a76aa3b7a0a7a313d"
        };

        const GLASS_CLASSES = "bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl shadow-lg";
        const INPUT_CLASSES = "w-full bg-black/20 border border-white/10 rounded-xl p-4 text-white placeholder-slate-500 focus:outline-none focus:border-white/30 transition-colors";
        const BUTTON_CLASSES = "w-full bg-white/10 hover:bg-white/20 active:bg-white/30 text-white font-medium py-3 rounded-xl transition-all border border-white/5";

        const Tab = {
            TODAY: 'TODAY',
            GOALS: 'GOALS',
            DASHBOARD: 'DASHBOARD',
            SETTINGS: 'SETTINGS',
        };

        // --- FIREBASE SERVICES ---
        const app = initializeApp(FIREBASE_CONFIG);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- AUTH LOGIC ---
        const signInWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Firebase Auth failed:", error);
                if (error.code === 'auth/unauthorized-domain') {
                    const currentDomain = window.location.hostname;
                    alert(`⚠️ DOMAIN NOT AUTHORIZED ⚠️\nAdd this to Firebase Console: ${currentDomain}`);
                } else if (error.code !== 'auth/popup-closed-by-user') {
                    alert("Sign in failed: " + error.message);
                }
            }
        };

        const logout = async () => {
            try { await signOut(auth); } catch (error) { console.error("Error signing out", error); }
        };

        const subscribeToAuth = (callback) => {
            return onAuthStateChanged(auth, (user) => {
                if (user && ALLOWED_EMAIL && user.email !== ALLOWED_EMAIL) {
                    alert("Access Denied: Restricted.");
                    signOut(auth);
                    callback(null);
                } else {
                    callback(user);
                }
            });
        };

        const getTodayString = () => new Date().toISOString().split('T')[0];
        const getCurrentMonthStr = () => new Date().toISOString().slice(0, 7);
        const getCurrentYearStr = () => new Date().getFullYear().toString();

        // --- COMPONENTS ---
        
        const GlassCard = ({ children, className = "", onClick }) => (
            <div className={`${GLASS_CLASSES} ${className}`} onClick={onClick}>{children}</div>
        );

        const BottomNav = ({ activeTab, onTabChange }) => {
            const navItems = [
                { id: Tab.TODAY, icon: Calendar, label: "Today" },
                { id: Tab.DASHBOARD, icon: LayoutDashboard, label: "Analytics" },
                { id: Tab.GOALS, icon: Target, label: "Goals" },
                { id: Tab.SETTINGS, icon: Settings, label: "Settings" },
            ];

            return (
                <div className="fixed bottom-0 left-0 right-0 p-4 z-40">
                    <nav className={`${GLASS_CLASSES} flex justify-around items-center p-2 bg-black/60 backdrop-blur-2xl`}>
                        {navItems.map((item) => {
                            const isActive = activeTab === item.id;
                            const Icon = item.icon;
                            return (
                                <button
                                    key={item.id}
                                    onClick={() => onTabChange(item.id)}
                                    className={`flex flex-col items-center justify-center p-3 rounded-xl w-full transition-all duration-300 ${
                                        isActive ? 'text-white bg-white/10' : 'text-slate-500 hover:text-slate-300'
                                    }`}
                                >
                                    <Icon size={24} strokeWidth={isActive ? 2.5 : 2} />
                                    <span className={`text-[10px] mt-1 font-medium ${isActive ? 'opacity-100' : 'opacity-0 hidden'}`}>
                                        {item.label}
                                    </span>
                                </button>
                            );
                        })}
                    </nav>
                </div>
            );
        };

        // --- VIEWS ---

        const TodayView = ({ user }) => {
            const [habits, setHabits] = useState([]);
            const [logs, setLogs] = useState([]);
            const [activeGoals, setActiveGoals] = useState([]);
            const todayStr = getTodayString();
            const currentMonth = getCurrentMonthStr();
            const currentYear = getCurrentYearStr();

            useEffect(() => {
                // Fetch Habits
                const unsubHabits = onSnapshot(query(collection(db, "habits"), where("uid", "==", user.uid)), 
                    (snap) => setHabits(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.name.localeCompare(b.name))));
                
                // Fetch Logs for Today
                const unsubLogs = onSnapshot(query(collection(db, "logs"), where("uid", "==", user.uid), where("dateString", "==", todayStr)),
                    (snap) => setLogs(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))));

                // Fetch Active Goals (Monthly & Yearly) for Today's view
                const unsubGoals = onSnapshot(query(collection(db, "goals"), where("uid", "==", user.uid)), 
                    (snap) => {
                        const allGoals = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        const releventGoals = allGoals.filter(g => 
                            (g.type === 'MONTHLY' && g.period === currentMonth) || 
                            (g.type === 'YEARLY') // Yearly goals always show
                        );
                        setActiveGoals(releventGoals);
                    });

                return () => { unsubHabits(); unsubLogs(); unsubGoals(); };
            }, [user.uid]);

            const toggleHabit = async (habit) => {
                const existingLog = logs.find(log => log.habitId === habit.id);
                if (existingLog) {
                    await deleteDoc(doc(db, "logs", existingLog.id));
                } else {
                    await addDoc(collection(db, "logs"), {
                        uid: user.uid,
                        habitId: habit.id,
                        dateString: todayStr,
                    });
                }
            };
            
            const adjustGoal = async (goalId, amount) => {
                const goalRef = doc(db, "goals", goalId);
                await updateDoc(goalRef, { current: increment(amount) });
            };

            const completedCount = logs.length;
            const percentage = habits.length > 0 ? Math.round((completedCount / habits.length) * 100) : 0;
            const radius = 50;
            const circumference = 2 * Math.PI * radius;
            const strokeDashoffset = circumference - (percentage / 100) * circumference;

            return (
                <div className="flex flex-col space-y-6 pb-24 animate-fade-in">
                    {/* Header */}
                    <div className="flex items-center justify-between px-2">
                        <div>
                            <h1 className="text-3xl font-light text-white tracking-tight">Good Morning,</h1>
                            <p className="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-200 to-purple-200">
                                {user.displayName?.split(' ')[0] || 'User'}
                            </p>
                            <p className="text-sm text-slate-400 mt-1">{new Date().toDateString()}</p>
                        </div>
                        <div className="relative w-20 h-20 flex items-center justify-center">
                            <svg className="transform -rotate-90 w-20 h-20">
                                <circle className="text-white/5" strokeWidth="6" stroke="currentColor" fill="transparent" r={radius} cx="40" cy="40" />
                                <circle className="text-emerald-400 transition-all duration-1000 ease-out" strokeWidth="6" strokeDasharray={circumference} strokeDashoffset={strokeDashoffset} strokeLinecap="round" stroke="currentColor" fill="transparent" r={radius} cx="40" cy="40" />
                            </svg>
                            <span className="absolute text-sm font-bold text-white">{percentage}%</span>
                        </div>
                    </div>

                    {/* Habits List */}
                    <div className="space-y-3">
                        <h2 className="px-2 text-sm font-semibold text-slate-400 uppercase tracking-wider">Daily Routine</h2>
                        {habits.length === 0 ? (
                            <div className="text-center p-6 text-slate-500 bg-white/5 rounded-2xl border border-white/5 border-dashed">No habits yet.</div>
                        ) : (
                            habits.map(habit => {
                                const isCompleted = logs.some(log => log.habitId === habit.id);
                                return (
                                    <GlassCard key={habit.id} className={`p-4 flex items-center justify-between transition-all active:scale-[0.98] cursor-pointer ${isCompleted ? 'bg-emerald-500/10 border-emerald-500/20' : ''}`} onClick={() => toggleHabit(habit)}>
                                        <span className={`text-lg font-medium transition-colors ${isCompleted ? 'text-emerald-200 line-through' : 'text-slate-200'}`}>{habit.name}</span>
                                        <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${isCompleted ? 'bg-emerald-500 border-emerald-500' : 'border-white/20'}`}>
                                            {isCompleted && <Check size={14} className="text-black" strokeWidth={3} />}
                                        </div>
                                    </GlassCard>
                                );
                            })
                        )}
                    </div>

                    {/* Active Goals Section in Today View */}
                    {activeGoals.length > 0 && (
                        <div className="space-y-3 pt-2">
                             <h2 className="px-2 text-sm font-semibold text-slate-400 uppercase tracking-wider">Current Focus</h2>
                             <div className="grid gap-3">
                                {activeGoals.map(goal => {
                                    const hasTarget = goal.target && goal.target > 0;
                                    const progress = hasTarget ? Math.min(100, (goal.current / goal.target) * 100) : 0;
                                    return (
                                        <GlassCard key={goal.id} className="p-4 flex flex-col space-y-2">
                                            <div className="flex justify-between items-center">
                                                <div className="flex items-center gap-2">
                                                    {goal.type === 'MONTHLY' ? <CalendarRange size={14} className="text-blue-400" /> : <Trophy size={14} className="text-amber-400" />}
                                                    <span className="text-sm font-medium text-slate-200">{goal.name}</span>
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    <span className="text-sm font-bold text-white">{goal.current} {hasTarget && <span className="text-slate-500 text-xs font-normal">/ {goal.target}</span>}</span>
                                                </div>
                                            </div>
                                            {hasTarget && (
                                                <div className="h-1.5 w-full bg-black/40 rounded-full overflow-hidden">
                                                    <div className="h-full bg-gradient-to-r from-blue-500 to-purple-500" style={{ width: `${progress}%` }} />
                                                </div>
                                            )}
                                            <div className="flex justify-end gap-2 pt-1">
                                                <button onClick={() => adjustGoal(goal.id, 1)} className="p-1.5 bg-white/10 rounded-lg hover:bg-white/20 text-white"><Plus size={16} /></button>
                                            </div>
                                        </GlassCard>
                                    );
                                })}
                             </div>
                        </div>
                    )}
                </div>
            );
        };

        const DashboardView = ({ user }) => {
            const [logs, setLogs] = useState([]);
            const [habits, setHabits] = useState([]);
            // Initialize date range to last 30 days by default
            const [startDate, setStartDate] = useState(() => {
                const d = new Date();
                d.setDate(d.getDate() - 29);
                return d.toISOString().split('T')[0];
            });
            const [endDate, setEndDate] = useState(() => new Date().toISOString().split('T')[0]);

            useEffect(() => {
                const unsubHabits = onSnapshot(query(collection(db, "habits"), where("uid", "==", user.uid)), (snap) => setHabits(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                
                // Fetch ALL logs initially - for client side filtering logic (better for small datasets vs complex firestore queries)
                // In a production app with huge data, we would query by date range in Firestore.
                const unsubLogs = onSnapshot(query(collection(db, "logs"), where("uid", "==", user.uid)), 
                    (snap) => setLogs(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                
                return () => { unsubHabits(); unsubLogs(); };
            }, [user.uid]);

            // Filter logs based on date range
            const filteredLogs = useMemo(() => {
                return logs.filter(log => log.dateString >= startDate && log.dateString <= endDate);
            }, [logs, startDate, endDate]);

            // Analytics Logic
            const totalCompletions = filteredLogs.length;
            
            // Heatmap & Graph Data Generation
            const dateMap = useMemo(() => {
                const map = new Map();
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                // Fill all dates in range with 0
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    map.set(d.toISOString().split('T')[0], 0);
                }
                
                // Fill actual counts
                filteredLogs.forEach(log => {
                    const val = map.get(log.dateString) || 0;
                    map.set(log.dateString, val + 1);
                });
                return map;
            }, [filteredLogs, startDate, endDate]);

            const chartData = Array.from(dateMap.entries()).sort();
            const maxCount = Math.max(...chartData.map(([, count]) => count), 1);

            // SVG Path for Area Chart
            const getSvgPath = () => {
                if (chartData.length < 2) return "";
                const width = 100;
                const height = 40;
                const dx = width / (chartData.length - 1);
                
                let path = `M 0,${height} `;
                chartData.forEach(([, count], i) => {
                    const x = i * dx;
                    const y = height - (count / maxCount) * height * 0.8; // Use 80% height max
                    path += `L ${x},${y} `;
                });
                path += `L 100,${height} Z`;
                return path;
            };

            return (
                <div className="flex flex-col space-y-6 pb-24 animate-fade-in">
                    <div className="px-2">
                        <h1 className="text-3xl font-light text-white tracking-tight flex items-center gap-2">
                            Analytics <TrendingUp className="text-emerald-400" size={28} />
                        </h1>
                    </div>

                    {/* Date Picker Range */}
                    <GlassCard className="p-3">
                         <div className="flex items-center gap-2 text-sm text-slate-400 mb-2">
                             <CalendarDays size={14} /> <span>Analysis Range</span>
                         </div>
                         <div className="flex gap-2">
                             <input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="bg-black/30 border border-white/10 rounded-lg p-2 text-white text-xs w-full focus:outline-none" />
                             <input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} className="bg-black/30 border border-white/10 rounded-lg p-2 text-white text-xs w-full focus:outline-none" />
                         </div>
                    </GlassCard>

                    {/* Key Stats */}
                    <div className="grid grid-cols-2 gap-4">
                        <GlassCard className="p-4 flex flex-col items-center justify-center">
                            <span className="text-3xl font-bold text-emerald-400">{totalCompletions}</span>
                            <span className="text-[10px] text-slate-400 uppercase tracking-widest mt-1 text-center">Total Habit Follows</span>
                        </GlassCard>
                        <GlassCard className="p-4 flex flex-col items-center justify-center">
                            <span className="text-3xl font-bold text-blue-400">{habits.length}</span>
                            <span className="text-[10px] text-slate-400 uppercase tracking-widest mt-1">Active Habits</span>
                        </GlassCard>
                    </div>

                    {/* Consistency Graph */}
                    <section>
                         <h2 className="text-sm font-semibold text-slate-400 mb-3 px-2 uppercase tracking-wider">Consistency Trend</h2>
                         <GlassCard className="p-4 overflow-hidden relative h-32 flex items-end">
                             <svg viewBox="0 0 100 40" preserveAspectRatio="none" className="w-full h-full absolute bottom-0 left-0">
                                 <defs>
                                     <linearGradient id="gradient" x1="0" x2="0" y1="0" y2="1">
                                         <stop offset="0%" stopColor="#10b981" stopOpacity="0.5" />
                                         <stop offset="100%" stopColor="#10b981" stopOpacity="0" />
                                     </linearGradient>
                                 </defs>
                                 <path d={getSvgPath()} fill="url(#gradient)" stroke="#34d399" strokeWidth="0.5" />
                             </svg>
                         </GlassCard>
                    </section>

                    {/* Contribution Heatmap */}
                    <section>
                        <h2 className="text-sm font-semibold text-slate-400 mb-3 px-2 uppercase tracking-wider">Heatmap</h2>
                        <GlassCard className="p-4 overflow-x-auto">
                            <div className="flex flex-wrap gap-1 content-start justify-center" style={{ minWidth: '100%' }}>
                                {chartData.map(([date, count]) => {
                                    // Heatmap colors based on intensity
                                    let bgClass = "bg-white/5";
                                    if (count > 0) bgClass = "bg-emerald-900";
                                    if (count > 1) bgClass = "bg-emerald-700";
                                    if (count > 3) bgClass = "bg-emerald-500";
                                    if (count > 5) bgClass = "bg-emerald-300";

                                    return (
                                        <div 
                                            key={date} 
                                            className={`w-3 h-3 rounded-sm ${bgClass}`} 
                                            title={`${date}: ${count} habits`}
                                        />
                                    );
                                })}
                            </div>
                        </GlassCard>
                    </section>
                </div>
            );
        };

        const GoalsView = ({ user }) => {
            const [goals, setGoals] = useState([]);
            const [viewMode, setViewMode] = useState('MONTHLY');
            const currentMonthStr = getCurrentMonthStr();

            useEffect(() => {
                const unsub = onSnapshot(query(collection(db, "goals"), where("uid", "==", user.uid)), (snap) => setGoals(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                return () => unsub();
            }, [user.uid]);

            const filteredGoals = goals.filter(g => {
                if (viewMode === 'YEARLY') return g.type === 'YEARLY';
                // Only show current month's goals in monthly view
                if (viewMode === 'MONTHLY') return g.type === 'MONTHLY' && g.period === currentMonthStr;
                return false;
            });

            const adjustGoal = async (goalId, amount) => {
                await updateDoc(doc(db, "goals", goalId), { current: increment(amount) });
            };

            return (
                <div className="flex flex-col space-y-6 pb-24 animate-fade-in">
                    <div className="px-2">
                        <h1 className="text-3xl font-light text-white tracking-tight">Goals</h1>
                        <p className="text-sm text-slate-400 mt-1">
                            {viewMode === 'MONTHLY' ? new Date().toLocaleString('default', { month: 'long', year: 'numeric' }) : new Date().getFullYear()}
                        </p>
                    </div>

                    <div className="bg-black/20 p-1 rounded-xl flex border border-white/5">
                        <button onClick={() => setViewMode('MONTHLY')} className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all ${viewMode === 'MONTHLY' ? 'bg-white/10 text-white shadow-sm' : 'text-slate-500'}`}>Monthly</button>
                        <button onClick={() => setViewMode('YEARLY')} className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all ${viewMode === 'YEARLY' ? 'bg-white/10 text-white shadow-sm' : 'text-slate-500'}`}>Yearly</button>
                    </div>

                    <div className="space-y-4">
                        {filteredGoals.length === 0 ? (
                            <div className="text-center p-8 text-slate-500 bg-white/5 rounded-2xl border border-white/5 border-dashed">
                                No {viewMode.toLowerCase()} goals for this specific time period.
                            </div>
                        ) : (
                            filteredGoals.map(goal => {
                                const hasTarget = goal.target && goal.target > 0;
                                const progress = hasTarget ? Math.min(100, Math.max(0, (goal.current / goal.target) * 100)) : 0;
                                return (
                                    <GlassCard key={goal.id} className="p-5 flex flex-col space-y-4 relative overflow-hidden">
                                        <div className="flex justify-between items-end relative z-10">
                                            <div>
                                                <h3 className="text-xl font-bold text-slate-100">{goal.name}</h3>
                                                <p className="text-sm text-slate-400 mt-1">
                                                    Current: <span className="text-white font-mono font-bold text-lg">{goal.current}</span>
                                                    {hasTarget && <span> / {goal.target}</span>}
                                                </p>
                                            </div>
                                            {hasTarget && <span className="text-2xl font-bold text-white/90">{Math.round(progress)}%</span>}
                                        </div>
                                        {hasTarget && (
                                            <div className="h-3 w-full bg-black/40 rounded-full overflow-hidden border border-white/5 relative z-10">
                                                <div className="h-full bg-gradient-to-r from-blue-500 to-purple-600 transition-all duration-500" style={{ width: `${progress}%` }} />
                                            </div>
                                        )}
                                        <div className="flex space-x-3 pt-2 relative z-10">
                                            <button onClick={() => adjustGoal(goal.id, -1)} className="flex-1 bg-white/5 hover:bg-white/10 p-2 rounded-xl flex items-center justify-center border border-white/10"><Minus size={20} className="text-slate-300" /></button>
                                            <button onClick={() => adjustGoal(goal.id, 1)} className="flex-1 bg-white/10 hover:bg-white/20 p-2 rounded-xl flex items-center justify-center border border-white/10"><Plus size={20} className="text-white" /></button>
                                        </div>
                                    </GlassCard>
                                );
                            })
                        )}
                    </div>
                </div>
            );
        };

        const NotesOverlay = ({ user, onClose }) => {
            const [activeTab, setActiveTab] = useState('IDEAS'); // IDEAS | EXECUTED
            const [notes, setNotes] = useState([]);
            const [text, setText] = useState("");

            useEffect(() => {
                const q = query(collection(db, "notes"), where("uid", "==", user.uid));
                const unsub = onSnapshot(q, (snap) => setNotes(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => b.createdAt - a.createdAt)));
                return () => unsub();
            }, [user.uid]);

            const addNote = async (e) => {
                e.preventDefault();
                if (!text.trim()) return;
                await addDoc(collection(db, "notes"), { uid: user.uid, text, status: 'PENDING', createdAt: Date.now() });
                setText("");
            };

            const executeNote = async (id) => {
                await updateDoc(doc(db, "notes", id), { status: 'EXECUTED', executedAt: Date.now() });
            };

            const filteredNotes = notes.filter(n => activeTab === 'IDEAS' ? n.status === 'PENDING' : n.status === 'EXECUTED');

            return (
                <div className="fixed inset-0 z-50 bg-[#0f172a] overflow-y-auto animate-slide-in-right">
                    <div className="max-w-md mx-auto min-h-screen p-4 flex flex-col">
                        <div className="flex items-center gap-4 mb-6">
                            <button onClick={onClose} className="p-2 bg-white/10 rounded-full hover:bg-white/20"><ArrowLeft size={20} /></button>
                            <h1 className="text-2xl font-light text-white">Someday Notes</h1>
                        </div>

                        {/* Tabs */}
                        <div className="flex bg-black/20 p-1 rounded-xl mb-6">
                            <button onClick={() => setActiveTab('IDEAS')} className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${activeTab === 'IDEAS' ? 'bg-white/10 text-white' : 'text-slate-500'}`}>Ideas</button>
                            <button onClick={() => setActiveTab('EXECUTED')} className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${activeTab === 'EXECUTED' ? 'bg-emerald-500/20 text-emerald-300' : 'text-slate-500'}`}>Executed</button>
                        </div>

                        {activeTab === 'IDEAS' && (
                            <form onSubmit={addNote} className="mb-6 relative">
                                <textarea 
                                    value={text} 
                                    onChange={e => setText(e.target.value)} 
                                    placeholder="Type your idea here..." 
                                    className={`${INPUT_CLASSES} min-h-[100px] resize-none`}
                                />
                                <button type="submit" className="absolute bottom-3 right-3 p-2 bg-blue-500 rounded-full hover:bg-blue-600 transition-colors shadow-lg">
                                    <Plus size={20} />
                                </button>
                            </form>
                        )}

                        <div className="space-y-3 pb-10">
                            {filteredNotes.length === 0 ? (
                                <div className="text-center text-slate-500 mt-10">No notes found.</div>
                            ) : (
                                filteredNotes.map(note => (
                                    <GlassCard key={note.id} className="p-4 flex gap-3 items-start">
                                        <div className="mt-1">
                                            {note.status === 'EXECUTED' ? <CheckSquare size={20} className="text-emerald-400" /> : <Lightbulb size={20} className="text-amber-400" />}
                                        </div>
                                        <div className="flex-1">
                                            <p className="text-slate-200 text-sm whitespace-pre-wrap leading-relaxed">{note.text}</p>
                                            <p className="text-[10px] text-slate-500 mt-2">
                                                {new Date(note.createdAt).toLocaleDateString()}
                                            </p>
                                        </div>
                                        {note.status === 'PENDING' && (
                                            <button onClick={() => executeNote(note.id)} className="p-2 bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 rounded-lg text-xs font-bold border border-emerald-500/20 transition-all flex flex-col items-center gap-1">
                                                <Rocket size={16} /> Execute
                                            </button>
                                        )}
                                    </GlassCard>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsView = ({ user }) => {
            const [showNotes, setShowNotes] = useState(false);
            const [habitName, setHabitName] = useState("");
            const [goalName, setGoalName] = useState("");
            const [goalTarget, setGoalTarget] = useState(""); // Optional now
            const [goalType, setGoalType] = useState('MONTHLY');
            const [habits, setHabits] = useState([]);
            const [goals, setGoals] = useState([]);

            useEffect(() => {
                const unsubHabits = onSnapshot(query(collection(db, "habits"), where("uid", "==", user.uid)), (snap) => setHabits(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubGoals = onSnapshot(query(collection(db, "goals"), where("uid", "==", user.uid)), (snap) => setGoals(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                return () => { unsubHabits(); unsubGoals(); };
            }, [user.uid]);

            const handleCreateHabit = async (e) => {
                e.preventDefault();
                if (!habitName.trim()) return;
                await addDoc(collection(db, "habits"), { uid: user.uid, name: habitName, createdAt: Date.now() });
                setHabitName("");
            };

            const handleCreateGoal = async (e) => {
                e.preventDefault();
                if (!goalName.trim()) return;
                
                const targetVal = goalTarget ? Number(goalTarget) : 0; // 0 means infinite/optional
                const data = { uid: user.uid, name: goalName, target: targetVal, current: 0, createdAt: Date.now(), type: goalType };
                
                // Assign specific period
                if (goalType === 'MONTHLY') {
                    data.period = getCurrentMonthStr(); // e.g., 2023-10
                } else {
                    data.period = getCurrentYearStr(); // e.g., 2023
                }

                await addDoc(collection(db, "goals"), data);
                setGoalName(""); setGoalTarget("");
                alert(`${goalType === 'MONTHLY' ? 'Monthly' : 'Yearly'} goal added!`);
            };

            const handleDelete = async (collectionName, id) => {
                if (confirm("Are you sure?")) await deleteDoc(doc(db, collectionName, id));
            };

            if (showNotes) return <NotesOverlay user={user} onClose={() => setShowNotes(false)} />;

            return (
                <div className="flex flex-col space-y-8 pb-24 animate-fade-in">
                    <div className="flex justify-between items-center px-2">
                        <h1 className="text-3xl font-light text-white tracking-tight">Settings</h1>
                        <button onClick={logout} className="p-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-full border border-red-500/20 transition-colors">
                            <LogOut size={20} />
                        </button>
                    </div>

                    {/* Someday Notes Entry */}
                    <GlassCard className="p-5 flex items-center justify-between cursor-pointer hover:bg-white/10 transition-colors group" onClick={() => setShowNotes(true)}>
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-amber-500/10 flex items-center justify-center border border-amber-500/20">
                                <Lightbulb size={20} className="text-amber-400 group-hover:scale-110 transition-transform" />
                            </div>
                            <div>
                                <h3 className="text-white font-medium">Someday Notes</h3>
                                <p className="text-xs text-slate-400">Capture ideas & execute them later</p>
                            </div>
                        </div>
                        <div className="bg-white/5 p-2 rounded-lg"><Plus size={16} /></div>
                    </GlassCard>

                    <section>
                        <h2 className="text-lg font-semibold text-slate-300 mb-3 px-2">Manage Habits</h2>
                        <GlassCard className="p-5">
                            <form onSubmit={handleCreateHabit} className="space-y-4">
                                <input type="text" value={habitName} onChange={(e) => setHabitName(e.target.value)} placeholder="e.g., Morning Jog" className={INPUT_CLASSES} />
                                <button type="submit" className={BUTTON_CLASSES}><div className="flex items-center justify-center gap-2"><PlusCircle size={20} /> Add Habit</div></button>
                            </form>
                        </GlassCard>
                        <div className="mt-4 space-y-2 max-h-40 overflow-y-auto">
                            {habits.map(h => (
                                <div key={h.id} className="flex items-center justify-between p-3 bg-white/5 rounded-xl border border-white/5">
                                    <span className="text-slate-300">{h.name}</span>
                                    <button onClick={() => handleDelete("habits", h.id)} className="text-slate-500 hover:text-red-400 transition-colors"><Trash2 size={18} /></button>
                                </div>
                            ))}
                        </div>
                    </section>

                    <section>
                        <h2 className="text-lg font-semibold text-slate-300 mb-3 px-2">Add Goal</h2>
                        <GlassCard className="p-5">
                            <form onSubmit={handleCreateGoal} className="space-y-4">
                                <div className="flex bg-black/30 p-1 rounded-lg">
                                    <button type="button" onClick={() => setGoalType('MONTHLY')} className={`flex-1 py-2 text-xs rounded-md transition-colors ${goalType === 'MONTHLY' ? 'bg-white/20 text-white' : 'text-slate-400'}`}>Monthly Goal</button>
                                    <button type="button" onClick={() => setGoalType('YEARLY')} className={`flex-1 py-2 text-xs rounded-md transition-colors ${goalType === 'YEARLY' ? 'bg-white/20 text-white' : 'text-slate-400'}`}>Yearly Goal</button>
                                </div>
                                <input type="text" value={goalName} onChange={(e) => setGoalName(e.target.value)} placeholder={goalType === 'MONTHLY' ? "e.g., Read 2 Books" : "e.g., Save $5000"} className={INPUT_CLASSES} />
                                <input type="number" value={goalTarget} onChange={(e) => setGoalTarget(e.target.value)} placeholder="Target (Optional)" className={INPUT_CLASSES} />
                                <button type="submit" className={BUTTON_CLASSES}><div className="flex items-center justify-center gap-2"><PlusCircle size={20} /> Add {goalType === 'MONTHLY' ? 'Monthly' : 'Yearly'} Goal</div></button>
                            </form>
                        </GlassCard>
                         <div className="mt-4 space-y-2 max-h-40 overflow-y-auto">
                            {goals.map(g => (
                                <div key={g.id} className="flex items-center justify-between p-3 bg-white/5 rounded-xl border border-white/5">
                                    <div className="flex flex-col">
                                        <div className="flex items-center gap-2">
                                            <span className="text-slate-300">{g.name}</span>
                                            <span className={`text-[10px] px-1.5 py-0.5 rounded ${g.type === 'MONTHLY' ? 'bg-blue-500/20 text-blue-300' : 'bg-purple-500/20 text-purple-300'}`}>{g.type === 'MONTHLY' ? 'Mo.' : 'Yr.'}</span>
                                        </div>
                                        <span className="text-[10px] text-slate-500">{g.period} • Target: {g.target || '∞'}</span>
                                    </div>
                                    <button onClick={() => handleDelete("goals", g.id)} className="text-slate-500 hover:text-red-400 transition-colors"><Trash2 size={18} /></button>
                                </div>
                            ))}
                        </div>
                    </section>
                </div>
            );
        };

        // --- APP ENTRY ---

        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState(Tab.TODAY);

            useEffect(() => {
                const unsubscribe = subscribeToAuth((currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            if (loading) return <div className="min-h-screen bg-slate-900 flex items-center justify-center"><div className="animate-spin h-8 w-8 border-4 border-slate-700 border-t-white rounded-full"></div></div>;

            if (!user) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-black flex items-center justify-center p-6">
                        <GlassCard className="w-full max-w-sm p-8 flex flex-col items-center text-center space-y-8 animate-fade-in-up">
                            <div className="w-20 h-20 bg-white/10 rounded-full flex items-center justify-center border border-white/20 shadow-xl shadow-blue-900/20">
                                <Lock size={40} className="text-blue-300" />
                            </div>
                            <div>
                                <h1 className="text-4xl font-light text-white mb-2">Life Tracker</h1>
                                <p className="text-slate-400">Secure Personal Workspace</p>
                            </div>
                            <button onClick={signInWithGoogle} className={BUTTON_CLASSES}>
                                <span className="flex items-center justify-center gap-2">Sign in with Google</span>
                            </button>
                            {ALLOWED_EMAIL ? (
                                <p className="text-xs text-slate-500 flex items-center gap-1"><ShieldAlert size={12} /> Restricted to Owner</p>
                            ) : (
                                <p className="text-xs text-slate-500">Your data is private and encrypted.</p>
                            )}
                        </GlassCard>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-black text-slate-100 font-sans selection:bg-blue-500/30">
                    <main className="max-w-md mx-auto min-h-screen p-4">
                        {activeTab === Tab.TODAY && <TodayView user={user} />}
                        {activeTab === Tab.DASHBOARD && <DashboardView user={user} />}
                        {activeTab === Tab.GOALS && <GoalsView user={user} />}
                        {activeTab === Tab.SETTINGS && <SettingsView user={user} />}
                    </main>
                    <BottomNav activeTab={activeTab} onTabChange={setActiveTab} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
