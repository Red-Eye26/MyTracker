<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Life Tracker</title>
    
    <!-- App Icon / Mobile Home Screen Image -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='120' fill='%230f172a'/%3E%3Ccircle cx='256' cy='256' r='160' fill='url(%23grad)'/%3E%3Cpath d='M164 266 L224 326 L348 186' stroke='white' stroke-width='40' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%233b82f6;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23a855f7;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='120' fill='%230f172a'/%3E%3Ccircle cx='256' cy='256' r='160' fill='url(%23grad)'/%3E%3Cpath d='M164 266 L224 326 L348 186' stroke='white' stroke-width='40' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%233b82f6;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23a855f7;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3C/svg%3E">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Babel for JSX support -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Add Poppins Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
      body {
        background-color: #0f172a; /* slate-900 fallback */
        color: #f1f5f9; /* slate-100 */
        -webkit-font-smoothing: antialiased;
        font-family: 'Poppins', sans-serif; /* Changed to Poppins */
      }
      /* Hide scrollbar for clean mobile look */
      ::-webkit-scrollbar {
        width: 0px;
        background: transparent;
      }
      .animate-fade-in {
        animation: fadeIn 0.5s ease-out;
      }
      .animate-fade-in-up {
        animation: fadeInUp 0.5s ease-out;
      }
      .animate-slide-in-right {
        animation: slideInRight 0.3s ease-out;
      }
      .cursor-blink {
        animation: blink 1s step-end infinite;
      }
      @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0; }
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes slideInRight {
        from { opacity: 0; transform: translateX(100%); }
        to { opacity: 1; transform: translateX(0); }
      }
      /* Date picker custom styles - Invert colors for dark mode */
      input[type="date"]::-webkit-calendar-picker-indicator,
      input[type="month"]::-webkit-calendar-picker-indicator {
        filter: invert(1);
        cursor: pointer;
      }
    </style>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.3.1",
        "react/": "https://esm.sh/react@18.3.1/",
        "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <!-- Changed type to text/babel and added data-type="module" -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Calendar, Target, Settings, LayoutDashboard, 
            Plus, Minus, Trophy, CalendarRange, 
            TrendingUp, Zap, CheckCircle2, 
            Trash2, LogOut, PlusCircle, Check, Lock, ShieldAlert,
            Lightbulb, ArrowLeft, CheckSquare, CalendarDays, Rocket, BarChart3, X,
            Clock, CalendarClock, Medal
        } from 'lucide-react';
        
        import { initializeApp } from "firebase/app";
        import { 
            getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged 
        } from "firebase/auth";
        import { 
            getFirestore, collection, query, where, addDoc, deleteDoc, doc, updateDoc, increment, onSnapshot, limit, orderBy 
        } from "firebase/firestore";

        // --- SECURITY CONFIGURATION ---
        const ALLOWED_EMAIL = ""; 

        // --- CONSTANTS ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCFQQHx_XumqSgEWfZQav8Wpx0UxMmFj6s",
            authDomain: "life-tracker-1d35b.firebaseapp.com",
            projectId: "life-tracker-1d35b",
            storageBucket: "life-tracker-1d35b.firebasestorage.app",
            messagingSenderId: "571383830152",
            appId: "1:571383830152:web:3c752a76aa3b7a0a7a313d"
        };

        const QUOTES = [
            "We donâ€™t need effort, we need results.",
            "Stop explainingâ€”just accept you failed.",
            "Anyone else couldâ€™ve done this better.",
            "Youâ€™re replaceable, donâ€™t forget that.",
            "Trying isnâ€™t impressive.",
            "You always need more time than others.",
            "This isnâ€™t hardâ€”why are you struggling?",
            "We lowered expectations for you already.",
            "Youâ€™re not bad, justâ€¦ not good.",
            "You make things more complicated than they need to be.",
            "You had one job.",
            "Excuses wonâ€™t change the outcome.",
            "If you were capable, we wouldnâ€™t be having this conversation.",
            "Youâ€™re too slow for real pressure.",
            "Potential doesnâ€™t matter if you never deliver.",
            "We canâ€™t keep carrying you.",
            "Others donâ€™t need this much guidance.",
            "Youâ€™re falling behindâ€”and it shows.",
            "No one asked you to struggle this much.",
            "At some point, effort stops being an excuse.",
            "You always miss something important.",
            "Youâ€™re not failing dramaticallyâ€”just consistently.",
            "We expected growth, not repetition.",
            "Youâ€™re exhausting to manage.",
            "You donâ€™t learn fast enough.",
            "This shouldnâ€™t need to be explained again.",
            "Youâ€™re not improving at the pace we need.",
            "We canâ€™t wait forever for you to catch up.",
            "Being busy doesnâ€™t mean being useful.",
            "You cost more time than you save.",
            "Youâ€™re not meeting the standardâ€”again.",
            "We thought youâ€™d figure this out by now.",
            "Your best isnâ€™t enough here.",
            "You slow the whole process down.",
            "Youâ€™re always one step behind everyone else.",
            "We need reliability, not apologies.",
            "You overestimate your contribution.",
            "This role might be too much for you.",
            "We donâ€™t see leadership in you.",
            "If this is your limit, say it."
        ];

        const GLASS_CLASSES = "bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl shadow-lg";
        const INPUT_CLASSES = "w-full bg-black/20 border border-white/10 rounded-xl p-4 text-white placeholder-slate-500 focus:outline-none focus:border-white/30 transition-colors font-poppins";
        const BUTTON_CLASSES = "w-full bg-white/10 hover:bg-white/20 active:bg-white/30 text-white font-medium py-3 rounded-xl transition-all border border-white/5";

        const Tab = {
            TODAY: 'TODAY',
            GOALS: 'GOALS',
            SETTINGS: 'SETTINGS',
        };

        // --- FIREBASE SERVICES ---
        const app = initializeApp(FIREBASE_CONFIG);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- HELPERS ---
        // Format Date to dd/mm/yyyy
        const formatDateDisplay = (dateStr) => {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB'); // dd/mm/yyyy
        };
        
        const getTodayString = () => new Date().toISOString().split('T')[0];
        const getCurrentMonthStr = () => new Date().toISOString().slice(0, 7);
        const getCurrentYearStr = () => new Date().getFullYear().toString();

        const formatPeriodDisplay = (type, period) => {
            if (!period) return 'No Deadline';
            if (type === 'YEARLY') return period; // 2024
            // Monthly: 2024-10
            const [y, m] = period.split('-');
            const date = new Date(y, m - 1);
            return date.toLocaleString('default', { month: 'long', year: 'numeric' });
        };

        // --- AUTH LOGIC ---
        const signInWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Firebase Auth failed:", error);
                if (error.code === 'auth/unauthorized-domain') {
                    const currentDomain = window.location.hostname;
                    alert(`âš ï¸ DOMAIN NOT AUTHORIZED âš ï¸\nAdd this to Firebase Console: ${currentDomain}`);
                } else if (error.code !== 'auth/popup-closed-by-user') {
                    alert("Sign in failed: " + error.message);
                }
            }
        };

        const logout = async () => {
            try { await signOut(auth); } catch (error) { console.error("Error signing out", error); }
        };

        const subscribeToAuth = (callback) => {
            return onAuthStateChanged(auth, (user) => {
                if (user && ALLOWED_EMAIL && user.email !== ALLOWED_EMAIL) {
                    alert("Access Denied: Restricted.");
                    signOut(auth);
                    callback(null);
                } else {
                    callback(user);
                }
            });
        };

        // --- COMPONENTS ---
        
        const GlassCard = ({ children, className = "", onClick }) => (
            <div className={`${GLASS_CLASSES} ${className}`} onClick={onClick}>{children}</div>
        );

        const BottomNav = ({ activeTab, onTabChange }) => {
            const navItems = [
                { id: Tab.TODAY, icon: Calendar, label: "Today" },
                { id: Tab.GOALS, icon: Target, label: "Goals" },
                { id: Tab.SETTINGS, icon: Settings, label: "Settings" },
            ];

            return (
                <div className="fixed bottom-0 left-0 right-0 p-4 z-40">
                    <nav className={`${GLASS_CLASSES} flex justify-around items-center p-2 bg-black/60 backdrop-blur-2xl`}>
                        {navItems.map((item) => {
                            const isActive = activeTab === item.id;
                            const Icon = item.icon;
                            return (
                                <button
                                    key={item.id}
                                    onClick={() => onTabChange(item.id)}
                                    className={`flex flex-col items-center justify-center p-3 rounded-xl w-full transition-all duration-300 ${
                                        isActive ? 'text-white bg-white/10' : 'text-slate-500 hover:text-slate-300'
                                    }`}
                                >
                                    <Icon size={24} strokeWidth={isActive ? 2.5 : 2} />
                                    <span className={`text-[10px] mt-1 font-medium ${isActive ? 'opacity-100' : 'opacity-0 hidden'}`}>
                                        {item.label}
                                    </span>
                                </button>
                            );
                        })}
                    </nav>
                </div>
            );
        };

        const Typewriter = () => {
            const [index, setIndex] = useState(0);
            const [subIndex, setSubIndex] = useState(0);
            const [reverse, setReverse] = useState(false);
            const [phase, setPhase] = useState('TYPING'); // TYPING | PAUSING | DELETING

            // Shuffle quotes on mount or pick random start
            const randomStart = useMemo(() => Math.floor(Math.random() * QUOTES.length), []);
            const currentIndex = (randomStart + index) % QUOTES.length;
            const currentQuote = QUOTES[currentIndex];

            useEffect(() => {
                let timeout;

                if (phase === 'TYPING') {
                    if (subIndex < currentQuote.length) {
                        timeout = setTimeout(() => {
                            setSubIndex(prev => prev + 1);
                        }, 40); // Typing speed ~40ms
                    } else {
                        // Finished typing
                        setPhase('PAUSING');
                    }
                } else if (phase === 'PAUSING') {
                    timeout = setTimeout(() => {
                        setPhase('DELETING');
                    }, 5000); // 5 seconds rest
                } else if (phase === 'DELETING') {
                    if (subIndex > 0) {
                        timeout = setTimeout(() => {
                            setSubIndex(prev => prev - 1);
                        }, 25); // Backspacing speed ~25ms
                    } else {
                        // Finished deleting
                        setPhase('TYPING');
                        setIndex(prev => prev + 1);
                    }
                }

                return () => clearTimeout(timeout);
            }, [subIndex, phase, currentQuote]);

            return (
                <div className="min-h-[3rem] flex items-center mb-1">
                    <h1 className="text-xl md:text-2xl font-light text-slate-100 tracking-tight leading-snug">
                        {currentQuote.substring(0, subIndex)}
                        <span className="cursor-blink ml-0.5 text-blue-400 font-normal">|</span>
                    </h1>
                </div>
            );
        };

        // --- VIEWS ---

        const TodayView = ({ user }) => {
            const [habits, setHabits] = useState([]);
            const [logs, setLogs] = useState([]);
            const [activeGoals, setActiveGoals] = useState([]);
            const [pendingNotes, setPendingNotes] = useState([]);
            const [showQuickNotes, setShowQuickNotes] = useState(false);
            const [goalFilter, setGoalFilter] = useState('ALL'); // ALL | MONTHLY | YEARLY
            
            const todayStr = getTodayString();
            const currentMonth = getCurrentMonthStr();

            useEffect(() => {
                const unsubHabits = onSnapshot(query(collection(db, "habits"), where("uid", "==", user.uid)), 
                    (snap) => setHabits(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.name.localeCompare(b.name))));
                
                const unsubLogs = onSnapshot(query(collection(db, "logs"), where("uid", "==", user.uid), where("dateString", "==", todayStr)),
                    (snap) => setLogs(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))));

                const unsubGoals = onSnapshot(query(collection(db, "goals"), where("uid", "==", user.uid)), 
                    (snap) => {
                        const allGoals = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        // SHOW ALL ACTIVE GOALS (No date filtering as requested)
                        const releventGoals = allGoals.filter(g => g.status !== 'COMPLETED');
                        setActiveGoals(releventGoals);
                    });
                
                const unsubNotes = onSnapshot(query(collection(db, "notes"), where("uid", "==", user.uid), where("status", "==", "PENDING")), 
                    (snap) => {
                        let allNotes = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        allNotes.sort((a, b) => b.createdAt - a.createdAt);
                        setPendingNotes(allNotes.slice(0, 3));
                    });

                return () => { unsubHabits(); unsubLogs(); unsubGoals(); unsubNotes(); };
            }, [user.uid]);

            const toggleHabit = async (habit) => {
                const existingLog = logs.find(log => log.habitId === habit.id);
                if (existingLog) {
                    await deleteDoc(doc(db, "logs", existingLog.id));
                } else {
                    await addDoc(collection(db, "logs"), {
                        uid: user.uid,
                        habitId: habit.id,
                        dateString: todayStr,
                    });
                }
            };
            
            const adjustGoal = async (goal, amount) => {
                const newCurrent = (goal.current || 0) + amount;
                
                if (goal.target && newCurrent >= goal.target && amount > 0) {
                    // Goal Completed!
                    if (confirm(`ðŸŽ‰ Amazing! You've reached your target for "${goal.name}". Mark as Completed?`)) {
                        await updateDoc(doc(db, "goals", goal.id), { 
                            current: newCurrent,
                            status: 'COMPLETED',
                            completedAt: Date.now()
                        });
                    } else {
                         await updateDoc(doc(db, "goals", goal.id), { current: newCurrent });
                    }
                } else {
                     await updateDoc(doc(db, "goals", goal.id), { current: newCurrent });
                }
            };
            
            const markAsDone = async (goal) => {
                if (confirm(`Mark "${goal.name}" as completed?`)) {
                    await updateDoc(doc(db, "goals", goal.id), { 
                        status: 'COMPLETED',
                        completedAt: Date.now()
                    });
                }
            };

            const completedCount = logs.length;
            const percentage = habits.length > 0 ? Math.round((completedCount / habits.length) * 100) : 0;
            const radius = 50;
            const circumference = 2 * Math.PI * radius;
            const strokeDashoffset = circumference - (percentage / 100) * circumference;

            const displayGoals = activeGoals.filter(g => {
                if (goalFilter === 'ALL') return true;
                return g.type === goalFilter;
            });

            return (
                <div className="flex flex-col space-y-6 pb-24 animate-fade-in relative">
                    <div className="flex items-center justify-between px-2 pt-2">
                        <div className="flex-1 pr-4">
                            <div className="flex items-center gap-2 mb-2">
                                <button onClick={() => setShowQuickNotes(true)} className="p-2 bg-amber-500/10 hover:bg-amber-500/20 rounded-full text-amber-400 border border-amber-500/20 transition-colors">
                                    <Lightbulb size={20} />
                                </button>
                                <p className="text-sm text-slate-400">{formatDateDisplay(new Date())}</p>
                            </div>
                            
                            {/* Typewriter Component Replacement */}
                            <Typewriter />
                            
                        </div>
                        <div className="relative w-20 h-20 flex items-center justify-center shrink-0">
                            <svg className="transform -rotate-90 w-20 h-20">
                                <circle className="text-white/5" strokeWidth="6" stroke="currentColor" fill="transparent" r={radius} cx="40" cy="40" />
                                <circle className="text-emerald-400 transition-all duration-1000 ease-out" strokeWidth="6" strokeDasharray={circumference} strokeDashoffset={strokeDashoffset} strokeLinecap="round" stroke="currentColor" fill="transparent" r={radius} cx="40" cy="40" />
                            </svg>
                            <span className="absolute text-sm font-bold text-white">{percentage}%</span>
                        </div>
                    </div>

                    {/* Quick Notes Popup */}
                    {showQuickNotes && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in" onClick={() => setShowQuickNotes(false)}>
                            <div className="bg-[#0f172a] border border-white/10 rounded-2xl w-full max-w-sm p-6 shadow-2xl relative animate-fade-in-up">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-white font-medium flex items-center gap-2"><Lightbulb size={18} className="text-amber-400" /> Recent Ideas</h3>
                                    <span className="text-xs text-slate-500">Tap anywhere to close</span>
                                </div>
                                <div className="space-y-3">
                                    {pendingNotes.length === 0 ? (
                                        <p className="text-sm text-slate-500 italic text-center py-4">No pending ideas.</p>
                                    ) : (
                                        pendingNotes.map(note => (
                                            <div key={note.id} className="p-3 bg-white/5 rounded-xl border border-white/5">
                                                <p className="text-slate-200 text-sm">{note.text}</p>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="space-y-3">
                        <h2 className="px-2 text-sm font-semibold text-slate-400 uppercase tracking-wider">Daily Routine</h2>
                        {habits.length === 0 ? (
                            <div className="text-center p-6 text-slate-500 bg-white/5 rounded-2xl border border-white/5 border-dashed">No habits yet.</div>
                        ) : (
                            habits.map(habit => {
                                const isCompleted = logs.some(log => log.habitId === habit.id);
                                return (
                                    <GlassCard key={habit.id} className={`p-4 flex items-center justify-between transition-all active:scale-[0.98] cursor-pointer ${isCompleted ? 'bg-emerald-500/10 border-emerald-500/20' : ''}`} onClick={() => toggleHabit(habit)}>
                                        <span className={`text-lg font-medium transition-colors ${isCompleted ? 'text-emerald-200 line-through' : 'text-slate-200'}`}>{habit.name}</span>
                                        <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${isCompleted ? 'bg-emerald-500 border-emerald-500' : 'border-white/20'}`}>
                                            {isCompleted && <Check size={14} className="text-black" strokeWidth={3} />}
                                        </div>
                                    </GlassCard>
                                );
                            })
                        )}
                    </div>

                    {activeGoals.length > 0 && (
                        <div className="space-y-3 pt-2">
                             <div className="flex justify-between items-center px-2">
                                <h2 className="text-sm font-semibold text-slate-400 uppercase tracking-wider">Current Focus</h2>
                                <div className="flex bg-white/5 rounded-lg p-0.5">
                                    <button onClick={() => setGoalFilter('ALL')} className={`px-2 py-0.5 text-[10px] rounded ${goalFilter === 'ALL' ? 'bg-white/10 text-white' : 'text-slate-500'}`}>All</button>
                                    <button onClick={() => setGoalFilter('MONTHLY')} className={`px-2 py-0.5 text-[10px] rounded ${goalFilter === 'MONTHLY' ? 'bg-white/10 text-white' : 'text-slate-500'}`}>Mo.</button>
                                    <button onClick={() => setGoalFilter('YEARLY')} className={`px-2 py-0.5 text-[10px] rounded ${goalFilter === 'YEARLY' ? 'bg-white/10 text-white' : 'text-slate-500'}`}>Yr.</button>
                                </div>
                             </div>
                             
                             <div className="grid gap-3">
                                {displayGoals.length === 0 ? (
                                    <div className="text-center text-xs text-slate-500 py-4">No {goalFilter !== 'ALL' ? goalFilter.toLowerCase() : ''} goals for this period.</div>
                                ) : (
                                    displayGoals.map(goal => {
                                        const hasTarget = goal.target && goal.target > 0;
                                        const progress = hasTarget ? Math.min(100, (goal.current / goal.target) * 100) : 0;
                                        return (
                                            <GlassCard key={goal.id} className="p-4 flex flex-col space-y-2">
                                                <div className="flex justify-between items-center">
                                                    <div className="flex items-center gap-2">
                                                        {goal.type === 'MONTHLY' ? <CalendarRange size={14} className="text-blue-400" /> : <Trophy size={14} className="text-amber-400" />}
                                                        <span className="text-sm font-medium text-slate-200">{goal.name}</span>
                                                    </div>
                                                    <div className="flex items-center gap-3">
                                                        <span className="text-sm font-bold text-white">{goal.current} {hasTarget && <span className="text-slate-500 text-xs font-normal">/ {goal.target}</span>}</span>
                                                    </div>
                                                </div>
                                                {hasTarget && (
                                                    <div className="h-1.5 w-full bg-black/40 rounded-full overflow-hidden">
                                                        <div className="h-full bg-gradient-to-r from-blue-500 to-purple-500" style={{ width: `${progress}%` }} />
                                                    </div>
                                                )}
                                                
                                                <div className="pt-2">
                                                    {!hasTarget ? (
                                                        <button onClick={() => markAsDone(goal)} className="w-full py-2 bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 rounded-xl border border-emerald-500/20 flex items-center justify-center gap-2 transition-all">
                                                            <CheckCircle2 size={18} /> Mark as Done
                                                        </button>
                                                    ) : (
                                                        <div className="flex justify-end gap-2">
                                                            <button onClick={() => adjustGoal(goal, -1)} className="p-2 bg-white/5 hover:bg-white/10 rounded-xl text-slate-400 border border-white/5"><Minus size={18} /></button>
                                                            <button onClick={() => adjustGoal(goal, 1)} className="p-2 bg-white/10 hover:bg-white/20 rounded-xl text-white border border-white/10"><Plus size={18} /></button>
                                                        </div>
                                                    )}
                                                </div>
                                            </GlassCard>
                                        );
                                    })
                                )}
                             </div>
                        </div>
                    )}
                </div>
            );
        };

        const AnalyticsOverlay = ({ user, onClose }) => {
            const [logs, setLogs] = useState([]);
            const [habits, setHabits] = useState([]);
            const [completedGoals, setCompletedGoals] = useState([]);
            const [startDate, setStartDate] = useState(() => {
                const d = new Date();
                d.setDate(d.getDate() - 29);
                return d.toISOString().split('T')[0];
            });
            const [endDate, setEndDate] = useState(() => new Date().toISOString().split('T')[0]);

            useEffect(() => {
                const unsubHabits = onSnapshot(query(collection(db, "habits"), where("uid", "==", user.uid)), (snap) => setHabits(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubLogs = onSnapshot(query(collection(db, "logs"), where("uid", "==", user.uid)), 
                    (snap) => setLogs(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubGoals = onSnapshot(query(collection(db, "goals"), where("uid", "==", user.uid), where("status", "==", "COMPLETED")),
                    (snap) => setCompletedGoals(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => b.completedAt - a.completedAt)));

                return () => { unsubHabits(); unsubLogs(); unsubGoals(); };
            }, [user.uid]);

            const filteredLogs = useMemo(() => {
                return logs.filter(log => log.dateString >= startDate && log.dateString <= endDate);
            }, [logs, startDate, endDate]);

            // 1. Total Stats
            const totalCompletions = filteredLogs.length;

            // 2. Weekly Pattern (Mon-Sun)
            const weeklyPattern = useMemo(() => {
                const days = [0,0,0,0,0,0,0]; // Sun to Sat
                filteredLogs.forEach(log => {
                    const d = new Date(log.dateString).getDay();
                    days[d]++;
                });
                // Rotate to make Monday first [1,2,3,4,5,6,0]
                return [...days.slice(1), days[0]];
            }, [filteredLogs]);
            const maxWeekly = Math.max(...weeklyPattern, 1);
            const weekLabels = ['M','T','W','T','F','S','S'];

            // 3. Habit Leaderboard
            const habitLeaderboard = useMemo(() => {
                const counts = {};
                filteredLogs.forEach(l => counts[l.habitId] = (counts[l.habitId] || 0) + 1);
                return habits.map(h => ({
                    name: h.name,
                    count: counts[h.id] || 0
                })).sort((a, b) => b.count - a.count).slice(0, 5); // Top 5
            }, [filteredLogs, habits]);

            // 4. Consistency Graph Data
            const dateMap = useMemo(() => {
                const map = new Map();
                const start = new Date(startDate);
                const end = new Date(endDate);
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    map.set(d.toISOString().split('T')[0], 0);
                }
                filteredLogs.forEach(log => {
                    const val = map.get(log.dateString) || 0;
                    map.set(log.dateString, val + 1);
                });
                return map;
            }, [filteredLogs, startDate, endDate]);
            const chartData = Array.from(dateMap.entries()).sort();
            const maxCount = Math.max(...chartData.map(([, count]) => count), 1);
            const getSvgPath = () => {
                if (chartData.length < 2) return "";
                const width = 100;
                const height = 40;
                const dx = width / (chartData.length - 1);
                let path = `M 0,${height} `;
                chartData.forEach(([, count], i) => {
                    const x = i * dx;
                    const y = height - (count / maxCount) * height * 0.8;
                    path += `L ${x},${y} `;
                });
                path += `L 100,${height} Z`;
                return path;
            };

            return (
                <div className="fixed inset-0 z-50 bg-[#0f172a] overflow-y-auto animate-slide-in-right">
                    <div className="max-w-md mx-auto min-h-screen p-4 flex flex-col space-y-6">
                        <div className="flex items-center gap-4">
                            <button onClick={onClose} className="p-2 bg-white/10 rounded-full hover:bg-white/20"><ArrowLeft size={20} /></button>
                            <h1 className="text-2xl font-light text-white flex items-center gap-2">Analytics <TrendingUp className="text-emerald-400" size={24} /></h1>
                        </div>

                        {/* Date Picker Range */}
                        <GlassCard className="p-3">
                             <div className="flex items-center gap-2 text-sm text-slate-400 mb-2">
                                 <CalendarDays size={14} /> <span>Analysis Range</span>
                             </div>
                             <div className="flex gap-2">
                                 <input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className={INPUT_CLASSES + " py-2 text-xs"} />
                                 <input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} className={INPUT_CLASSES + " py-2 text-xs"} />
                             </div>
                        </GlassCard>

                        {/* Achievements Trophy Room */}
                        <section>
                            <div className="flex items-center gap-2 mb-3 px-2">
                                <Medal size={16} className="text-amber-400" />
                                <h2 className="text-sm font-semibold text-slate-300 uppercase tracking-wider">Achievements</h2>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                {completedGoals.length === 0 ? (
                                    <div className="col-span-2 text-center text-slate-500 text-xs py-4 bg-white/5 rounded-xl border border-white/5 border-dashed">
                                        No completed goals yet. Keep pushing!
                                    </div>
                                ) : (
                                    completedGoals.map(goal => (
                                        <GlassCard key={goal.id} className="p-3 border-amber-500/20 bg-gradient-to-br from-amber-500/10 to-transparent flex flex-col justify-between">
                                            <div className="flex justify-between items-start mb-2">
                                                 <Trophy size={16} className="text-amber-400" />
                                                 <span className="text-[10px] text-amber-200/70">{formatPeriodDisplay(goal.type, goal.period)}</span>
                                            </div>
                                            <div>
                                                <h4 className="text-white font-medium text-sm leading-tight mb-1">{goal.name}</h4>
                                                <div className="text-xs text-amber-100/60">Hit Target: <span className="text-amber-400 font-bold">{goal.target}</span></div>
                                            </div>
                                        </GlassCard>
                                    ))
                                )}
                            </div>
                        </section>

                        <div className="grid grid-cols-2 gap-4">
                            <GlassCard className="p-4 flex flex-col items-center justify-center">
                                <span className="text-3xl font-bold text-emerald-400">{totalCompletions}</span>
                                <span className="text-[10px] text-slate-400 uppercase tracking-widest mt-1 text-center">Total Follows</span>
                            </GlassCard>
                            <GlassCard className="p-4 flex flex-col items-center justify-center">
                                <span className="text-3xl font-bold text-blue-400">{habits.length}</span>
                                <span className="text-[10px] text-slate-400 uppercase tracking-widest mt-1">Active Habits</span>
                            </GlassCard>
                        </div>

                        {/* Weekly Pattern Chart */}
                        <section>
                             <h2 className="text-sm font-semibold text-slate-400 mb-3 px-2 uppercase tracking-wider">Weekly Productivity Pattern</h2>
                             <GlassCard className="p-5 flex items-end justify-between h-32">
                                 {weeklyPattern.map((count, i) => {
                                     const heightPercent = (count / maxWeekly) * 100;
                                     return (
                                         <div key={i} className="flex flex-col items-center gap-2 w-full">
                                             <div className="w-2 bg-blue-500/50 rounded-t-sm transition-all duration-500" style={{ height: `${heightPercent || 5}%` }}></div>
                                             <span className="text-[10px] text-slate-500">{weekLabels[i]}</span>
                                         </div>
                                     )
                                 })}
                             </GlassCard>
                        </section>

                        {/* Habit Leaderboard */}
                        <section>
                            <h2 className="text-sm font-semibold text-slate-400 mb-3 px-2 uppercase tracking-wider">Top Habits (Selected Range)</h2>
                            <GlassCard className="p-4 space-y-3">
                                {habitLeaderboard.map((h, i) => (
                                    <div key={i} className="flex items-center gap-3">
                                        <div className="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center text-xs font-bold text-slate-400">#{i+1}</div>
                                        <div className="flex-1">
                                            <div className="flex justify-between text-xs mb-1">
                                                <span className="text-slate-200">{h.name}</span>
                                                <span className="text-emerald-400 font-bold">{h.count}</span>
                                            </div>
                                            <div className="h-1 bg-white/5 rounded-full overflow-hidden">
                                                <div className="h-full bg-emerald-500" style={{ width: `${(h.count / Math.max(habitLeaderboard[0].count, 1)) * 100}%` }}></div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                {habitLeaderboard.length === 0 && <div className="text-xs text-slate-500 text-center">No data available.</div>}
                            </GlassCard>
                        </section>

                        {/* Consistency Graph */}
                        <section>
                             <h2 className="text-sm font-semibold text-slate-400 mb-3 px-2 uppercase tracking-wider">Consistency Trend</h2>
                             <GlassCard className="p-4 overflow-hidden relative h-32 flex items-end">
                                 <svg viewBox="0 0 100 40" preserveAspectRatio="none" className="w-full h-full absolute bottom-0 left-0">
                                     <defs>
                                         <linearGradient id="gradient" x1="0" x2="0" y1="0" y2="1">
                                             <stop offset="0%" stopColor="#10b981" stopOpacity="0.5" />
                                             <stop offset="100%" stopColor="#10b981" stopOpacity="0" />
                                         </linearGradient>
                                     </defs>
                                     <path d={getSvgPath()} fill="url(#gradient)" stroke="#34d399" strokeWidth="0.5" />
                                 </svg>
                             </GlassCard>
                        </section>

                        {/* Heatmap */}
                        <section>
                            <h2 className="text-sm font-semibold text-slate-400 mb-3 px-2 uppercase tracking-wider">Heatmap</h2>
                            <GlassCard className="p-4 overflow-x-auto">
                                <div className="flex flex-wrap gap-1 content-start justify-center" style={{ minWidth: '100%' }}>
                                    {chartData.map(([date, count]) => {
                                        let bgClass = "bg-white/5";
                                        if (count > 0) bgClass = "bg-emerald-900";
                                        if (count > 1) bgClass = "bg-emerald-700";
                                        if (count > 3) bgClass = "bg-emerald-500";
                                        if (count > 5) bgClass = "bg-emerald-300";
                                        return (
                                            <div key={date} className={`w-3 h-3 rounded-sm ${bgClass}`} title={`${formatDateDisplay(date)}: ${count} habits`} />
                                        );
                                    })}
                                </div>
                            </GlassCard>
                        </section>
                        <div className="h-10"></div>
                    </div>
                </div>
            );
        };

        const GoalsView = ({ user }) => {
            const [goals, setGoals] = useState([]);
            const [viewMode, setViewMode] = useState('MONTHLY');
            const currentMonthStr = getCurrentMonthStr();
            const currentYearStr = getCurrentYearStr();

            useEffect(() => {
                const unsub = onSnapshot(query(collection(db, "goals"), where("uid", "==", user.uid)), (snap) => setGoals(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                return () => unsub();
            }, [user.uid]);

            // Filter by type, remove COMPLETED, sort by period
            const filteredGoals = goals
                .filter(g => g.type === viewMode && g.status !== 'COMPLETED')
                .sort((a, b) => {
                    if (!a.period || !b.period) return 0;
                    return a.period.localeCompare(b.period);
                });

            const adjustGoal = async (goal, amount) => {
                const newCurrent = (goal.current || 0) + amount;
                
                if (goal.target && newCurrent >= goal.target && amount > 0) {
                     if (confirm(`ðŸŽ‰ Amazing! You've reached your target for "${goal.name}". Mark as Completed?`)) {
                        await updateDoc(doc(db, "goals", goal.id), { 
                            current: newCurrent,
                            status: 'COMPLETED',
                            completedAt: Date.now()
                        });
                     } else {
                         await updateDoc(doc(db, "goals", goal.id), { current: newCurrent });
                     }
                } else {
                     await updateDoc(doc(db, "goals", goal.id), { current: newCurrent });
                }
            };

            const getGoalStatus = (goalPeriod) => {
                if (viewMode === 'MONTHLY') {
                    if (goalPeriod === currentMonthStr) return 'CURRENT';
                    if (goalPeriod > currentMonthStr) return 'UPCOMING';
                    return 'PAST';
                } else {
                    if (goalPeriod === currentYearStr) return 'CURRENT';
                    if (goalPeriod > currentYearStr) return 'UPCOMING';
                    return 'PAST';
                }
            };

            return (
                <div className="flex flex-col space-y-6 pb-24 animate-fade-in">
                    <div className="px-2">
                        <h1 className="text-3xl font-light text-white tracking-tight">Goals Timeline</h1>
                        <p className="text-sm text-slate-400 mt-1">
                            Tracking your {viewMode.toLowerCase()} roadmap
                        </p>
                    </div>

                    <div className="bg-black/20 p-1 rounded-xl flex border border-white/5">
                        <button onClick={() => setViewMode('MONTHLY')} className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all ${viewMode === 'MONTHLY' ? 'bg-white/10 text-white shadow-sm' : 'text-slate-500'}`}>Monthly</button>
                        <button onClick={() => setViewMode('YEARLY')} className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all ${viewMode === 'YEARLY' ? 'bg-white/10 text-white shadow-sm' : 'text-slate-500'}`}>Yearly</button>
                    </div>

                    <div className="space-y-4">
                        {filteredGoals.length === 0 ? (
                            <div className="text-center p-8 text-slate-500 bg-white/5 rounded-2xl border border-white/5 border-dashed">
                                No active {viewMode.toLowerCase()} goals found.
                            </div>
                        ) : (
                            filteredGoals.map(goal => {
                                const hasTarget = goal.target && goal.target > 0;
                                const progress = hasTarget ? Math.min(100, Math.max(0, (goal.current / goal.target) * 100)) : 0;
                                const status = getGoalStatus(goal.period);
                                
                                let statusColor = "text-slate-500";
                                let badgeBg = "bg-slate-500/10 text-slate-400";
                                if (status === 'CURRENT') {
                                    statusColor = "text-white";
                                    badgeBg = "bg-blue-500/20 text-blue-300 border border-blue-500/30";
                                } else if (status === 'UPCOMING') {
                                    statusColor = "text-slate-300";
                                    badgeBg = "bg-emerald-500/10 text-emerald-300";
                                }

                                return (
                                    <GlassCard key={goal.id} className={`p-5 flex flex-col space-y-4 relative overflow-hidden transition-all duration-300 ${status === 'CURRENT' ? 'border-blue-500/30 bg-white/10' : 'opacity-90'}`}>
                                        <div className="flex justify-between items-start relative z-10">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2 mb-2">
                                                    <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wider ${badgeBg}`}>
                                                        {status}
                                                    </span>
                                                    <div className="flex items-center gap-1 text-slate-400 text-xs">
                                                        <Clock size={12} />
                                                        <span>{formatPeriodDisplay(viewMode, goal.period)}</span>
                                                    </div>
                                                </div>
                                                <h3 className={`text-xl font-bold ${statusColor}`}>{goal.name}</h3>
                                                <p className="text-sm text-slate-400 mt-1">
                                                    Current: <span className="text-white font-mono font-bold text-lg">{goal.current}</span>
                                                    {hasTarget && <span> / {goal.target}</span>}
                                                </p>
                                            </div>
                                            {hasTarget && <span className="text-2xl font-bold text-white/90">{Math.round(progress)}%</span>}
                                        </div>
                                        {hasTarget && (
                                            <div className="h-3 w-full bg-black/40 rounded-full overflow-hidden border border-white/5 relative z-10">
                                                <div className="h-full bg-gradient-to-r from-blue-500 to-purple-600 transition-all duration-500" style={{ width: `${progress}%` }} />
                                            </div>
                                        )}
                                        <div className="flex space-x-3 pt-2 relative z-10">
                                            <button onClick={() => adjustGoal(goal, -1)} className="flex-1 bg-white/5 hover:bg-white/10 p-2 rounded-xl flex items-center justify-center border border-white/10"><Minus size={20} className="text-slate-300" /></button>
                                            <button onClick={() => adjustGoal(goal, 1)} className="flex-1 bg-white/10 hover:bg-white/20 p-2 rounded-xl flex items-center justify-center border border-white/10"><Plus size={20} className="text-white" /></button>
                                        </div>
                                    </GlassCard>
                                );
                            })
                        )}
                    </div>
                </div>
            );
        };

        const NotesOverlay = ({ user, onClose }) => {
            const [activeTab, setActiveTab] = useState('IDEAS'); // IDEAS | EXECUTED
            const [notes, setNotes] = useState([]);
            const [text, setText] = useState("");

            useEffect(() => {
                const q = query(collection(db, "notes"), where("uid", "==", user.uid));
                const unsub = onSnapshot(q, (snap) => setNotes(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => b.createdAt - a.createdAt)));
                return () => unsub();
            }, [user.uid]);

            const addNote = async (e) => {
                e.preventDefault();
                if (!text.trim()) return;
                await addDoc(collection(db, "notes"), { uid: user.uid, text, status: 'PENDING', createdAt: Date.now() });
                setText("");
            };

            const executeNote = async (id) => {
                await updateDoc(doc(db, "notes", id), { status: 'EXECUTED', executedAt: Date.now() });
            };

            const filteredNotes = notes.filter(n => activeTab === 'IDEAS' ? n.status === 'PENDING' : n.status === 'EXECUTED');

            return (
                <div className="fixed inset-0 z-50 bg-[#0f172a] overflow-y-auto animate-slide-in-right">
                    <div className="max-w-md mx-auto min-h-screen p-4 flex flex-col">
                        <div className="flex items-center gap-4 mb-6">
                            <button onClick={onClose} className="p-2 bg-white/10 rounded-full hover:bg-white/20"><ArrowLeft size={20} /></button>
                            <h1 className="text-2xl font-light text-white">Someday Notes</h1>
                        </div>

                        {/* Tabs */}
                        <div className="flex bg-black/20 p-1 rounded-xl mb-6">
                            <button onClick={() => setActiveTab('IDEAS')} className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${activeTab === 'IDEAS' ? 'bg-white/10 text-white' : 'text-slate-500'}`}>Ideas</button>
                            <button onClick={() => setActiveTab('EXECUTED')} className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${activeTab === 'EXECUTED' ? 'bg-emerald-500/20 text-emerald-300' : 'text-slate-500'}`}>Executed</button>
                        </div>

                        {activeTab === 'IDEAS' && (
                            <form onSubmit={addNote} className="mb-6 relative">
                                <textarea 
                                    value={text} 
                                    onChange={e => setText(e.target.value)} 
                                    placeholder="Type your idea here..." 
                                    className={`${INPUT_CLASSES} min-h-[100px] resize-none`}
                                />
                                <button type="submit" className="absolute bottom-3 right-3 p-2 bg-blue-500 rounded-full hover:bg-blue-600 transition-colors shadow-lg">
                                    <Plus size={20} />
                                </button>
                            </form>
                        )}

                        <div className="space-y-3 pb-10">
                            {filteredNotes.length === 0 ? (
                                <div className="text-center text-slate-500 mt-10">No notes found.</div>
                            ) : (
                                filteredNotes.map(note => (
                                    <GlassCard key={note.id} className="p-4 flex gap-3 items-start">
                                        <div className="mt-1">
                                            {note.status === 'EXECUTED' ? <CheckSquare size={20} className="text-emerald-400" /> : <Lightbulb size={20} className="text-amber-400" />}
                                        </div>
                                        <div className="flex-1">
                                            <p className="text-slate-200 text-sm whitespace-pre-wrap leading-relaxed">{note.text}</p>
                                            <p className="text-[10px] text-slate-500 mt-2">
                                                {formatDateDisplay(new Date(note.createdAt))}
                                            </p>
                                        </div>
                                        {note.status === 'PENDING' && (
                                            <button onClick={() => executeNote(note.id)} className="p-2 bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 rounded-lg text-xs font-bold border border-emerald-500/20 transition-all flex flex-col items-center gap-1">
                                                <Rocket size={16} /> Execute
                                            </button>
                                        )}
                                    </GlassCard>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsView = ({ user }) => {
            const [showNotes, setShowNotes] = useState(false);
            const [showAnalytics, setShowAnalytics] = useState(false);
            
            const [habitName, setHabitName] = useState("");
            
            // Goal State
            const [goalName, setGoalName] = useState("");
            const [goalTarget, setGoalTarget] = useState(""); 
            const [goalType, setGoalType] = useState('MONTHLY');
            const [selectedPeriod, setSelectedPeriod] = useState(getCurrentMonthStr()); // Default 2023-10
            
            const [habits, setHabits] = useState([]);
            const [goals, setGoals] = useState([]);

            useEffect(() => {
                const unsubHabits = onSnapshot(query(collection(db, "habits"), where("uid", "==", user.uid)), (snap) => setHabits(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubGoals = onSnapshot(query(collection(db, "goals"), where("uid", "==", user.uid)), (snap) => setGoals(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                return () => { unsubHabits(); unsubGoals(); };
            }, [user.uid]);

            const handleCreateHabit = async (e) => {
                e.preventDefault();
                if (!habitName.trim()) return;
                await addDoc(collection(db, "habits"), { uid: user.uid, name: habitName, createdAt: Date.now() });
                setHabitName("");
            };

            const handleCreateGoal = async (e) => {
                e.preventDefault();
                if (!goalName.trim()) return;
                
                const targetVal = goalTarget ? Number(goalTarget) : 0; 
                const data = { 
                    uid: user.uid, 
                    name: goalName, 
                    target: targetVal, 
                    current: 0, 
                    createdAt: Date.now(), 
                    type: goalType,
                    period: selectedPeriod // Use specific selected period
                };
                
                await addDoc(collection(db, "goals"), data);
                setGoalName(""); setGoalTarget("");
                alert(`${goalType === 'MONTHLY' ? 'Monthly' : 'Yearly'} goal added for ${selectedPeriod}!`);
            };

            const handleDelete = async (collectionName, id) => {
                if (confirm("Are you sure?")) await deleteDoc(doc(db, collectionName, id));
            };

            if (showNotes) return <NotesOverlay user={user} onClose={() => setShowNotes(false)} />;
            if (showAnalytics) return <AnalyticsOverlay user={user} onClose={() => setShowAnalytics(false)} />;

            return (
                <div className="flex flex-col space-y-8 pb-24 animate-fade-in">
                    <div className="flex justify-between items-center px-2">
                        <h1 className="text-3xl font-light text-white tracking-tight">Settings</h1>
                        <button onClick={logout} className="p-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-full border border-red-500/20 transition-colors">
                            <LogOut size={20} />
                        </button>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        {/* Someday Notes Entry */}
                        <GlassCard className="p-4 flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-white/10 transition-colors group text-center h-32" onClick={() => setShowNotes(true)}>
                            <div className="w-10 h-10 rounded-full bg-amber-500/10 flex items-center justify-center border border-amber-500/20">
                                <Lightbulb size={20} className="text-amber-400 group-hover:scale-110 transition-transform" />
                            </div>
                            <h3 className="text-white font-medium text-sm">Someday Notes</h3>
                        </GlassCard>

                        {/* Analytics Entry */}
                        <GlassCard className="p-4 flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-white/10 transition-colors group text-center h-32" onClick={() => setShowAnalytics(true)}>
                            <div className="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center border border-blue-500/20">
                                <BarChart3 size={20} className="text-blue-400 group-hover:scale-110 transition-transform" />
                            </div>
                            <h3 className="text-white font-medium text-sm">Analytics</h3>
                        </GlassCard>
                    </div>

                    <section>
                        <h2 className="text-lg font-semibold text-slate-300 mb-3 px-2">Manage Habits</h2>
                        <GlassCard className="p-5">
                            <form onSubmit={handleCreateHabit} className="space-y-4">
                                <input type="text" value={habitName} onChange={(e) => setHabitName(e.target.value)} placeholder="e.g., Morning Jog" className={INPUT_CLASSES} />
                                <button type="submit" className={BUTTON_CLASSES}><div className="flex items-center justify-center gap-2"><PlusCircle size={20} /> Add Habit</div></button>
                            </form>
                        </GlassCard>
                        <div className="mt-4 space-y-2 max-h-40 overflow-y-auto">
                            {habits.map(h => (
                                <div key={h.id} className="flex items-center justify-between p-3 bg-white/5 rounded-xl border border-white/5">
                                    <span className="text-slate-300">{h.name}</span>
                                    <button onClick={() => handleDelete("habits", h.id)} className="text-slate-500 hover:text-red-400 transition-colors"><Trash2 size={18} /></button>
                                </div>
                            ))}
                        </div>
                    </section>

                    <section>
                        <h2 className="text-lg font-semibold text-slate-300 mb-3 px-2">Add Goal</h2>
                        <GlassCard className="p-5">
                            <form onSubmit={handleCreateGoal} className="space-y-4">
                                <div className="flex bg-black/30 p-1 rounded-lg">
                                    <button type="button" onClick={() => { setGoalType('MONTHLY'); setSelectedPeriod(getCurrentMonthStr()); }} className={`flex-1 py-2 text-xs rounded-md transition-colors ${goalType === 'MONTHLY' ? 'bg-white/20 text-white' : 'text-slate-400'}`}>Monthly</button>
                                    <button type="button" onClick={() => { setGoalType('YEARLY'); setSelectedPeriod(getCurrentYearStr()); }} className={`flex-1 py-2 text-xs rounded-md transition-colors ${goalType === 'YEARLY' ? 'bg-white/20 text-white' : 'text-slate-400'}`}>Yearly</button>
                                </div>
                                
                                <input type="text" value={goalName} onChange={(e) => setGoalName(e.target.value)} placeholder={goalType === 'MONTHLY' ? "e.g., Read 2 Books" : "e.g., Save $5000"} className={INPUT_CLASSES} />
                                <input type="number" value={goalTarget} onChange={(e) => setGoalTarget(e.target.value)} placeholder="Target (Optional)" className={INPUT_CLASSES} />
                                
                                <div className="space-y-1">
                                    <label className="text-xs text-slate-400 ml-1">Deadline / Period</label>
                                    {goalType === 'MONTHLY' ? (
                                        <input type="month" value={selectedPeriod} onChange={(e) => setSelectedPeriod(e.target.value)} className={INPUT_CLASSES} />
                                    ) : (
                                        <input type="number" min="2024" max="2050" value={selectedPeriod} onChange={(e) => setSelectedPeriod(e.target.value)} className={INPUT_CLASSES} />
                                    )}
                                </div>

                                <button type="submit" className={BUTTON_CLASSES}><div className="flex items-center justify-center gap-2"><PlusCircle size={20} /> Add {goalType === 'MONTHLY' ? 'Monthly' : 'Yearly'} Goal</div></button>
                            </form>
                        </GlassCard>
                         <div className="mt-4 space-y-2 max-h-40 overflow-y-auto">
                            {goals.map(g => (
                                <div key={g.id} className="flex items-center justify-between p-3 bg-white/5 rounded-xl border border-white/5">
                                    <div className="flex flex-col">
                                        <div className="flex items-center gap-2">
                                            <span className="text-slate-300">{g.name}</span>
                                            <span className={`text-[10px] px-1.5 py-0.5 rounded ${g.type === 'MONTHLY' ? 'bg-blue-500/20 text-blue-300' : 'bg-purple-500/20 text-purple-300'}`}>{g.type === 'MONTHLY' ? 'Mo.' : 'Yr.'}</span>
                                        </div>
                                        <span className="text-[10px] text-slate-500">{g.period} â€¢ Target: {g.target || 'âˆž'}</span>
                                    </div>
                                    <button onClick={() => handleDelete("goals", g.id)} className="text-slate-500 hover:text-red-400 transition-colors"><Trash2 size={18} /></button>
                                </div>
                            ))}
                        </div>
                    </section>
                </div>
            );
        };

        // --- APP ENTRY ---

        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState(Tab.TODAY);

            useEffect(() => {
                const unsubscribe = subscribeToAuth((currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            if (loading) return <div className="min-h-screen bg-slate-900 flex items-center justify-center"><div className="animate-spin h-8 w-8 border-4 border-slate-700 border-t-white rounded-full"></div></div>;

            if (!user) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-black flex items-center justify-center p-6">
                        <GlassCard className="w-full max-w-sm p-8 flex flex-col items-center text-center space-y-8 animate-fade-in-up">
                            <div className="w-20 h-20 bg-white/10 rounded-full flex items-center justify-center border border-white/20 shadow-xl shadow-blue-900/20">
                                <Lock size={40} className="text-blue-300" />
                            </div>
                            <div>
                                <h1 className="text-4xl font-light text-white mb-2">Life Tracker</h1>
                                <p className="text-slate-400">Secure Personal Workspace</p>
                            </div>
                            <button onClick={signInWithGoogle} className={BUTTON_CLASSES}>
                                <span className="flex items-center justify-center gap-2">Sign in with Google</span>
                            </button>
                            {ALLOWED_EMAIL ? (
                                <p className="text-xs text-slate-500 flex items-center gap-1"><ShieldAlert size={12} /> Restricted to Owner</p>
                            ) : (
                                <p className="text-xs text-slate-500">Your data is private and encrypted.</p>
                            )}
                        </GlassCard>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-black text-slate-100 font-sans selection:bg-blue-500/30">
                    <main className="max-w-md mx-auto min-h-screen p-4">
                        {activeTab === Tab.TODAY && <TodayView user={user} />}
                        {activeTab === Tab.GOALS && <GoalsView user={user} />}
                        {activeTab === Tab.SETTINGS && <SettingsView user={user} />}
                    </main>
                    <BottomNav activeTab={activeTab} onTabChange={setActiveTab} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
